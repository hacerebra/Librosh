<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Librosh | Profil Düzenleme</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" type="image/svg+xml" href="assets/icons/favicon.svg">
  <link href="https://fonts.googleapis.com/css2?family=Bitcount+Grid+Double:wght@100..900&family=Manufacturing+Consent&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>
  <header class="site-header">
    <div class="logo">
      <img src="assets/icons/logo.png">
    </div>
    <nav class="menu">
      <a href="kategoriler.html" class="link-button"
        onmouseenter="this.querySelector('img').src='assets/icons/categories-light.svg'"
        onmouseleave="this.querySelector('img').src='assets/icons/categories.svg'">
        <img src="assets/icons/categories.svg" alt="Kategoriler İkonu" width="24" height="24">
        Kategoriler
      </a>
      <a href="kullanıcı-home.html" class="link-button"
        onmouseenter="this.querySelector('img').src='assets/icons/home-light.svg'"
        onmouseleave="this.querySelector('img').src='assets/icons/home.svg'">
        <img src="assets/icons/home.svg" alt="ev İkonu" width="24" height="24">
        Ana Sayfa
      </a>
      <a href="kitaplık.html" class="link-button"
        onmouseenter="this.querySelector('img').src='assets/icons/library-light.svg'"
        onmouseleave="this.querySelector('img').src='assets/icons/library.svg'">
        <img src="assets/icons/library.svg" alt="kitaplık İkonu" width="24" height="24">
        Kitaplığım
      </a>
      <a href="favoriler.html" class="link-button"
        onmouseenter="this.querySelector('img').src='assets/icons/heart-light.svg'"
        onmouseleave="this.querySelector('img').src='assets/icons/heart.svg'">
        <img src="assets/icons/heart.svg" alt="Kalp İkonu" width="24" height="24">
        Favorilerim
      </a>
      <a href="profil.html" class="link-button"
        onmouseenter="this.querySelector('img').src='assets/icons/user-light.svg'"
        onmouseleave="this.querySelector('img').src='assets/icons/user.svg'">
        <img src="assets/icons/user.svg" alt="Kullanıcı İkonu" width="24" height="24">
        Profilim
      </a>
      <a href="#" class="notification-icon" id="notificationIcon">
        <img src="assets/icons/bell.svg" alt="Bildirim İkonu" width="24" height="24">
        <span class="badge" id="notificationBadge">0</span>
      </a>   
      <a href="index.html" class="notification-icon">
        <img src="assets/icons/exit.svg" alt="Çıkış İkonu" width="24" height="24">
      </a>
    </nav>
  </header>
  
  <div class="background-profile">
    <section class="user-info">
   
      <div class="profile-photo-edit">
      <img src="assets/images/female.png" alt="Profil Fotoğrafı">
    </div>

    <form class="register-form-grid">
      <div class="input-wrapper">
        <label for="username">Kullanıcı adı</label>
        <input type="text" id="username" placeholder="Kullanıcı adı" />
      </div>
    
      <div class="input-wrapper">
        <label for="dob">Doğum Tarihi</label>
        <input type="date" id="dob" placeholder="gg.aa.yyyy" />
      </div>
    
      <div class="input-wrapper">
        <label for="gender">Cinsiyet</label>
        <select id="gender">
          <option value="">Seçiniz</option>
          <option value="Kadın">Kadın</option>
          <option value="Erkek">Erkek</option>
          <option value="Diğer">Diğer</option>
        </select>
        </div>
    
      <div class="input-wrapper">
        <label for="email">E-mail</label>
        <input type="email" id="email" placeholder="ex@example.com" />
      </div>

      <div class="input-wrapper">
        <label for="password">Şifre</label>
        <input type="password" id="password" placeholder="********" />
        <img src="assets/icons/eye.svg" alt="Göster" id="togglePassword1" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); cursor: pointer;" />
      </div>   
      
      <div class="input-wrapper">
        <label for="password2">Şifre Tekrar</label>
        <input type="password" id="password2" placeholder="********" />
        <img src="assets/icons/eye.svg" alt="Göster" id="togglePassword2" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); cursor: pointer;" />
      </div>   
      
      <button type="submit" class="register-button">Profili Güncelle</button>
    </form>  
  </section> 

  </div>
  <div id="customAlert" class="custom-alert">
    <div class="alert-box">
      <h3 class="alert-title">Bilgilendirme</h3>
      <p id="alertMessage"></p>
      <button onclick="closeCustomAlert()">Tamam</button>
    </div>
  </div>
</div>

<div id="notificationPanel">
  <div class="notification-header">
    <img src="assets/icons/bell.svg" alt="Bildirim" class="notif-bell-icon">
    <h3>Bildirimler</h3>
    <div class="notification-actions">
      <button id="markAllReadBtn">Tümünü Oku</button>
      <button id="clearAllBtn">Tümünü Sil</button>
      <button id="closeNotifBtn">✕</button>
    </div>
  </div>
  <div id="notificationList"></div>
</div>  

<script>
  // Şifre göster/gizle toggle işlevleri
  const togglePassword1 = document.getElementById("togglePassword1");
  const passwordInput1 = document.getElementById("password");

  togglePassword1.addEventListener("click", function () {
    const isPassword = passwordInput1.type === "password";
    passwordInput1.type = isPassword ? "text" : "password";
    this.src = isPassword
      ? "assets/icons/eye-off.svg"
      : "assets/icons/eye.svg";
    this.alt = isPassword ? "Gizle" : "Göster";
  });

  const togglePassword2 = document.getElementById("togglePassword2");
  const passwordInput2 = document.getElementById("password2");

  togglePassword2.addEventListener("click", function () {
    const isPassword = passwordInput2.type === "password";
    passwordInput2.type = isPassword ? "text" : "password";
    this.src = isPassword
      ? "assets/icons/eye-off.svg"
      : "assets/icons/eye.svg";
    this.alt = isPassword ? "Gizle" : "Göster";
  });

  // Select renk değişimi
  const genderSelect = document.getElementById("gender");

  function updateSelectColor() {
    genderSelect.style.color = genderSelect.value === "" ? "#C0C0C0" : "#4C4D7A";
  }

  window.addEventListener("load", updateSelectColor);
  genderSelect.addEventListener("change", updateSelectColor);

  // Kullanıcı verilerini doldur
  const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));

  if (loggedInUser) {
    const email = loggedInUser.email;
    const kitaplikKey = `kitaplik_${email}`;
    const favorilerKey = `favoriler_${email}`;

    const kitaplikList = JSON.parse(localStorage.getItem(kitaplikKey)) || [];
    const favorilerList = JSON.parse(localStorage.getItem(favorilerKey)) || [];

    if (document.querySelector("#kitaplikCount .count"))
      document.querySelector("#kitaplikCount .count").textContent =
        kitaplikList.length;
    if (document.querySelector("#favorilerCount .count"))
      document.querySelector("#favorilerCount .count").textContent =
        favorilerList.length;

    if (document.getElementById("kullaniciAdSoyad"))
      document.getElementById("kullaniciAdSoyad").innerHTML = `${loggedInUser.username} <img src="assets/icons/edit.svg" class="edit-icon" alt="Düzenle" />`;

    document.getElementById("username").value = loggedInUser.username || "";
    document.getElementById("dob").value = loggedInUser.dob || "";
    document.getElementById("gender").value = loggedInUser.gender || "";
    document.getElementById("email").value = loggedInUser.email || "";

    const profilePhoto = document.querySelector(".profile-photo-edit img");
    if (loggedInUser.gender?.toLowerCase() === "erkek") {
      profilePhoto.src = "assets/images/male.png";
    } else if (loggedInUser.gender?.toLowerCase() === "kadın") {
      profilePhoto.src = "assets/images/female.png";
    } else {
      profilePhoto.src = "assets/images/male.png";
    }
  }

  // Form gönderme işlemi
  document
  .querySelector(".register-form-grid")
  .addEventListener("submit", function (e) {
    e.preventDefault();

    const updatedUser = {
      ...loggedInUser,
      username: document.getElementById("username").value,
      dob: document.getElementById("dob").value,
      gender: document.getElementById("gender").value,
      email: document.getElementById("email").value,
    };

    const newPassword = document.getElementById("password").value;
    const newPassword2 = document.getElementById("password2").value;

    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;

    if (newPassword || newPassword2) {
      if (newPassword !== newPassword2) {
        showCustomAlert("Şifreler uyuşmuyor!");
        return;
      }
      if (!passwordRegex.test(newPassword)) {
        showCustomAlert("Şifre en az 8 karakter, bir büyük harf, bir küçük harf, bir rakam ve bir özel karakter içermelidir.");
        return;
      }
      updatedUser.password = newPassword;
    }

    // Tüm kullanıcıları al
    let users = JSON.parse(localStorage.getItem("users")) || [];

    // Başka biri bu e-posta ile kayıtlı mı kontrol et
    const emailExists = users.some(user => user.email === updatedUser.email && user.email !== loggedInUser.email);

    if (emailExists) {
      showCustomAlert("Bu e-posta ile zaten kayıt olunmuş.");
      return;
    }

    // Güncellenmiş kullanıcıyı users dizisinde değiştir
    const updatedUsers = users.map(user =>
      user.email === loggedInUser.email ? updatedUser : user
    );

    localStorage.setItem("users", JSON.stringify(updatedUsers));
    localStorage.setItem("loggedInUser", JSON.stringify(updatedUser));

    showCustomAlert("Profiliniz başarıyla güncellendi.");
    setTimeout(() => {
      window.location.href = "profil.html";
    }, 2000);
  });

</script>
 <script src="alert.js"></script>
 <script src="bildirim.js"></script>
</body>
</html>
